{% extends "base.html" %}
{% load static %}
{% load i18n %}
{% load widget_tweaks %}
{% load pagination_tags %}


{% load extra_tags %}
{% block title %} Events Board {% endblock %}

{% block content %}
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>

<style type="text/css" media="print">
   .no-print { display: none; }

</style>
<style type="text/css">
    .fade_me {
    filter: alpha(opacity=60);
    opacity: 0.60;
   }

   tr:hover {
    filter: alpha(opacity=100);
    opacity: 1;
   }
</style>
        <div class="page-header">
            <h1>Events Board</h1>
        </div>
            <div class="ibox float-e-margins">
            <div class="ibox-title">
                    <h5>Filter details </h5> <span id="filter-details" class="label label-danger"></span>
                    <div class="ibox-tools">
                        <a class="collapse-link">
                            <i class="fa fa-chevron-up"></i>
                        </a>
                    </div>
                </div>
                <div class="ibox-content">
                <div class="row container">
                       <form  action="" method="get">
                           <div class="col-md-12">

                          <div class="form-group col-md-3">
                            <label for="id_server">{% trans 'Server' %}:</label>
                            {{ filter.form.server|add_class:"form-control input-sm" }}
                          </div>
                          <div class="form-group col-md-3">
                            <label for="id_service">{% trans 'Service' %}:</label>
                            {{ filter.form.service|add_class:"form-control input-sm" }}
                          </div>
                          <div class="form-group col-md-3">
                            <label for="id_event_type">{% trans 'Event Type' %}:</label>
                            {{ filter.form.event_type|add_class:"form-control input-sm" }}
                          </div>

                           <div class="form-group col-md-3">
                            <label for="id_event_id">{% trans 'Event ID' %}:</label>
                            {{ filter.form.event_id|add_class:"form-control input-sm" }}
                          </div>
                          <div class="form-group col-md-3">
                            <label for="id_event_state">{% trans 'Event State' %}:</label>
                            {{ filter.form.event_state|add_class:"form-control input-sm" }}
                          </div>
                          <div class="form-group col-md-3">
                            <label for="id_event_message">{% trans 'Event Message' %}:</label>
                            {{ filter.form.event_message|add_class:"form-control input-sm" }}
                          </div>
                         <div class="form-group col-md-2">
                            <label for="id_alarm_raised">{% trans 'Raised ?' %}:</label>
                            {{ filter.form.alarm_raised|add_class:"form-control input-sm" }}
                          </div>
                            <div class="form-group col-md-2">
                            <label for="id_is_ack">{% trans 'Is Acknowledged ?' %}:</label>
                            {{ filter.form.is_ack|add_class:"form-control input-sm" }}
                          </div>
                           <div class="form-group col-md-4">
                            {{ filter.form.event_time.label_tag }}
                            {{ filter.form.event_time|add_class:"form-control input-sm"|attr:'autocomplete:off' }}
                          </div>


                          </div>
                          <div class="col-md-12">
                             <div class="hr-line-dashed"></div>
                            <input class="btn btn-primary" type="submit" value="{% trans 'Filter' %}" />
                             <div class="hr-line-dashed"></div>

                          </div>
                </form>
</div>
                </div>
              </div>
                  {% autopaginate filter.qs 10 as filter_list %}

            <div class="ibox float-e-margins">
                <div class="ibox-content">
                    <div class="table-responsive">
                        <table class="table table-striped table-bordered table-hover" id="event_table">
                            <thead>
                                <tr>
                                    <th>Message</th>
                                    <th>Date </th>
                                    <th>Event</th>
                                    <th>Type</th>
                                    <th>Monit Action</th>
                                    <th>Raised</th>
                                    <th>Duplicate of</th>
                                    <th>cleared by</th>
                                    <th>cleared </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for monit_event in filter_list %}
                                        <tr id="event-{{ monit_event.id }}" class="{% if monit_event.alarm_raised and not monit_event.cleared_by %}danger {% else %} fade_me {% endif %}">
                                            <td><small><span class="label label-warning" >{{ monit_event.id }}<span></small> {{ monit_event.event_message }}</td>
                                            <td>{{ monit_event.event_time }}</td>
                                            <td><b>{{ monit_event.event_id|event_status_to_string }}</b><b> <span class="label label-{{ monit_event.event_state|event_state_to_style }}">{{ monit_event.event_state|event_state_to_string }}</b></span></td>
                                            <td>{{ monit_event.event_type|type_to_string }}: <b>{{ monit_event.service}} </b></td>
                                            <td>{{ monit_event.event_action|action_to_string }}</td>
                                            <td>{% if monit_event.event_state == 1  %} {{ monit_event.alarm_raised|to_icon|safe }} {% else %} - {% endif%}</td>
                                            <td>{% if monit_event.event_state == 1  %} {{ monit_event.is_duplicate_of|to_btns|safe }} {% else %} - {% endif%}</td>
                                            <td>{% if monit_event.event_state == 1 and monit_event.cleared_by  %} {{ monit_event.cleared_by|to_btn|safe }} {% else %} - {% endif%}</td>
                                            <td>{% if monit_event.event_state == 0  %} {{ monit_event.cleared_alarms|to_btns|safe }} {% else %} - {% endif%}</td>

                                    </tr>
                                    <script language="javascript">
                                    // Submit post on submit
                                    $('#ack-{{ monit_event.id }}').on("click", function (event) {
                                    event_id = $(this).data("id");
                                    ack(event_id);
                                    return false
                                    });
                                    </script>
                                {% endfor %}
                            </tbody>
                                                   <tfoot>
                                <tr>
                                            <th>Message</th>
                                    <th>Date </th>
                                    <th>Event</th>
                                    <th>Type</th>
                                    <th>Monit Action</th>
                                    <th>Raised</th>
                                    <th>Duplicate of</th>
                                    <th>cleared by</th>
                                    <th>cleared </th>
                                    </tr>
                                </tfoot>
                        </table>
                    </div>

                     {% paginate %}

                </div>
            </div>

{% endblock %}
{% block customjs %}

 <script type="text/javascript">


    $(document).ready(function() {

    function getCookie(name) {
         var cookieValue = null;
         if (document.cookie && document.cookie != '') {
             var cookies = document.cookie.split(';');
             for (var i = 0; i < cookies.length; i++) {
                 var cookie = jQuery.trim(cookies[i]);
                 // Does this cookie string begin with the name we want?
                 if (cookie.substring(0, name.length + 1) == (name + '=')) {
                     cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                     break;
                 }
             }
         }
         return cookieValue;
     }

     var csrftoken = getCookie('csrftoken');

     function csrfSafeMethod(method) {
         // these HTTP methods do not require CSRF protection
         return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
     }

     $.ajaxSetup({
         beforeSend: function(xhr, settings) {
             if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                 xhr.setRequestHeader("X-CSRFToken", csrftoken);
             }
         }
     });

     // AJAX for posting
     var ack = function(event_id) {
         $.ajax({
             url: "{% url 'ui:ack_event' %}", // the endpoint
             type: "POST", // http method
             data: {
                 "event_id": event_id
             },
             // handle a successful response
             success: function(json) {
                 event_id = json.event_id
                 element_selector = "#event-element-" + event_id
                 $(element_selector).fadeOut(150)
             },
             // handle a non-successful response
             error: function(xhr, errmsg, err) {
                 $('#results').html("<div class='alert-box alert radius' data-alert>Oops! We have encountered an error: " + errmsg +
                     " <a href='#' class='close'>&times;</a></div>"); // add the error to the dom
                 console.log(xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
             }
         });
     };

     function getParameterByName(name, url) {
    if (!url) url = window.location.href;
    name = name.replace(/[\[\]]/g, "\\$&");
    var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)", "i"),
        results = regex.exec(url);
    if (!results) return null;
    if (!results[2]) return '';
    return decodeURIComponent(results[2].replace(/\+/g, " "));
}

    var ibox_header = ""
    var event_type = getParameterByName('event_type'); // "lorem"
    var event_id = getParameterByName('event_id'); // "" (present with empty value)
    var event_state = getParameterByName('event_state'); // "" (present with no value)
    var event_message = getParameterByName('event_message'); // null (absent)
    var alarm_raised = getParameterByName('alarm_raised'); // null (absent)
    var is_ack = getParameterByName('is_ack'); // null (absent)
    var server = getParameterByName('server'); // null (absent)


    if(server){
        ibox_header += " | Server :  <b>"+ $('#id_server option:selected').html()+"</b>"
    }
    if(event_type){
        ibox_header += " | Event type :  <b>"+ $('#id_event_type option:selected').html()+"</b>"
    }
    if(event_id){
        ibox_header += " | Event ID :  <b>"+ $('#id_event_id option:selected').html()+"</b>"
    }
    if(event_state){
        ibox_header += " | Event State :  <b>"+ $('#id_event_state option:selected').html()+"</b>"
    }
    if(event_message){
        ibox_header += " | Event Message contains  <b>'"+ $('#id_event_message').val()+"'</b>"
    }
    if(alarm_raised){
        var val = $('#id_alarm_raised option:selected').html()
        if (val!="Unknown")
            ibox_header += " | Is Raised? : "+val
    }
    if(is_ack){
        var val = $('#id_is_ack option:selected').html()
        if (val!="Unknown")
            ibox_header += " | Is Acknowledged ? : <b>"+ $('#id_is_ack option:selected').html()+"</b>"
    }
    $('#filter-details').html(ibox_header)
});
        </script>
    {% endblock customjs %}
