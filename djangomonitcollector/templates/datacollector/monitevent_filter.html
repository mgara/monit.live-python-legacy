{% extends "base.html" %}
{% load static %}
{% load i18n %}
{% load widget_tweaks %}
{% load pagination_tags %}
{% load bootstrap_pagination %}


{% load extra_tags %}
{% block title %} Events Dashboard {% endblock %}
{% block page_title %}Events Dashboard {% endblock %}
{% block head %}
    <link href="{% static 'css/plugins/bootstrap-markdown/bootstrap-markdown.min.css' %}" rel="stylesheet">
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>

<style type="text/css" media="print">
   .no-print { display: none; }

</style>
<style type="text/css">
    .fade_me {
    filter: alpha(opacity=60);
    opacity: 0.60;
   }

   tr:hover {
    filter: alpha(opacity=100);
    opacity: 1;
   }
</style>
{% endblock %}
{% block content %}
                {% autopaginate filter.qs 10 as filter_list %}

            <div class="ibox float-e-margins" id="ibox_filter">
            <div class="ibox-title">
                    <h5>Filter details </h5> <span id="filter-details" class="label label-danger"></span>
                    <div class="ibox-tools">
                        <a class="collapse-link">
                            <i class="fa fa-chevron-up"></i>
                        </a>
                    </div>
                </div>
                <div class="ibox-content" id="filter_properties">
                    <div class="row">
                       <form  action="" method="get">
                           <div class="col-md-12">

                          <div class="form-group col-md-3">
                            <label for="id_server">{% trans 'Server' %}:</label>
                            {{ filter.form.server|add_class:"form-control input-sm" }}
                          </div>
                          <div class="form-group col-md-3">
                            <label for="id_service">{% trans 'Service' %}:</label>
                            {{ filter.form.service|add_class:"form-control input-sm" }}
                          </div>
                          <div class="form-group col-md-3">
                            <label for="id_event_type">{% trans 'Event Type' %}:</label>
                            {{ filter.form.event_type|add_class:"form-control input-sm" }}
                          </div>

                           <div class="form-group col-md-3">
                            <label for="id_event_id">{% trans 'Event ID' %}:</label>
                            {{ filter.form.event_id|add_class:"form-control input-sm" }}
                          </div>
                          <div class="form-group col-md-3">
                            <label for="id_event_state">{% trans 'Event State' %}:</label>
                            {{ filter.form.event_state|add_class:"form-control input-sm" }}
                          </div>
                          <div class="form-group col-md-3">
                            <label for="id_event_message">{% trans 'Event Message' %}:</label>
                            {{ filter.form.event_message|add_class:"form-control input-sm" }}
                          </div>
                         <div class="form-group col-md-3">
                            <label for="id_alarm_raised">{% trans 'Raised ?' %}:</label>
                            {{ filter.form.alarm_raised|add_class:"form-control input-sm" }}
                          </div>
                            <div class="form-group col-md-3">
                            <label for="id_is_ack">{% trans 'Is Acknowledged ?' %}:</label>
                            {{ filter.form.is_ack|add_class:"form-control input-sm" }}
                          </div>
                           <div class="form-group col-md-4">
                            {{ filter.form.event_time.label_tag }}
                            {{ filter.form.event_time|add_class:"form-control input-sm"|attr:'autocomplete:off' }}
                          </div>


                          </div>
                          <div class="col-md-12">
                             <div class="hr-line-dashed"></div>
                            <input class="btn btn-primary" type="submit" value="{% trans 'Filter' %}" />
                             <div class="hr-line-dashed"></div>

                          </div>
                    </form>
                    </div>
                </div>
              </div>
<div class="row text-center">
                 {% bootstrap_paginate page_obj range=10 show_prev_next="true" show_first_last="true" %}
</div>

            <div class="ibox float-e-margins">
                <div class="ibox-content">
                    <div class="table-responsive">
                        <table class="table table-striped table-bordered table-hover" id="event_table">
                            <thead>
                                <tr>
                                    <th></th>
                                    <th>Server</th>
                                    <th>Message</th>
                                    <th>Event</th>
                                    <th>Type</th>
                                    <th>Monit Action</th>
                                    <th>Raised</th>
                                    <th class="col-sm-1">Duplicate of</th>
                                    <th>cleared by</th>
                                    <th>cleared </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for monit_event in filter_list %}

                                        <tr id="event-{{ monit_event.id }}" class="{% if monit_event.alarm_raised and not monit_event.cleared_by %}danger {% else %} fade_me {% endif %}">
                                            <td class="text-center"><small><span class="label" >{{ monit_event.id }}<span></small></td>
                                            <td><a class="text-success" target="_blank" href="{% url 'ui:server' monit_event.server.id %}" >{{ monit_event.server.localhostname }}</a></td>
                                            <td>


                                            <div class="media-body ">
                            <button class="pull-right btn btn-xs btn-danger btn-outline " data-toggle="tooltip" data-placement="top" title="{{ monit_event.event_time}}"> {{ monit_event.event_time|time_diff|format_timedelta }}</button>
                            <p class="m-b-xs">
                                 {{ monit_event.event_message }}
                            </p>
                            <small>   <a type="button" event-id="{{monit_event.id }}" class="view-event-comments label label-{{ monit_event.moniteventcomment_set.all|length|status_alert}}"><i class="fa fa-comment-o"></i>  <span>{{ monit_event.moniteventcomment_set.all|length}} </span> </a>
                                                <a type="button" class="view-event-details label label-default" event-id="{{  monit_event.id }}" href="#" onclick="return false;"><i class="fa fa-eye"></i> View</a></small>
                        </div>






                                            </td>
                                            <td><b>{{ monit_event.event_id|event_status_to_string }}</b><br/><b><span class="label label-{{ monit_event.event_state|event_state_to_style }}">{{ monit_event.event_state|event_state_to_string }}</b></span></td>
                                            <td>{{ monit_event.event_type|type_to_string }}<br/><strong>{{ monit_event.service}} </strong></td>
                                            <td>{{ monit_event.event_action|action_to_string }}</td>
                                            <td>{% if monit_event.event_state == 1  %} {{ monit_event.alarm_raised|to_icon|safe }} {% else %} - {% endif%}</td>
                                            <td>{% if monit_event.event_state == 1  %} {{ monit_event.is_duplicate_of|to_btns|safe }} {% else %} - {% endif%}</td>
                                            <td>{% if monit_event.event_state == 1 and monit_event.cleared_by  %} {{ monit_event.cleared_by|to_btn|safe }} {% else %} - {% endif%}</td>
                                            <td>{% if monit_event.event_state == 0  %} {{ monit_event.cleared_alarms|to_btns|safe }} {% else %} - {% endif%}</td>
                                    </tr>
                                         <script type="text/javascript">



                                        </script>
                                {% endfor %}
                            </tbody>
                                                   <tfoot>
                                <tr>
                                    <th></th>
                                    <th>Server</th>
                                    <th>Message</th>
                                    <th>Event</th>
                                    <th>Type</th>
                                    <th>Monit Action</th>
                                    <th>Raised</th>
                                    <th>Duplicate of</th>
                                    <th>cleared by</th>
                                    <th>cleared </th>
                                    </tr>
                                </tfoot>
                        </table>
                    </div>

                   <div class="row text-center">
                 {% bootstrap_paginate page_obj range=10 show_prev_next="true" show_first_last="true" %}
</div>

                </div>
            </div>

<div class="modal inmodal" id="event_modal" tabindex="-1" role="dialog" aria-hidden="true"></div>
{% endblock %}
{% block customjs %}


    <!-- Bootstrap markdown -->
    <script src="{% static 'js/plugins/bootstrap-markdown/bootstrap-markdown.js' %}"></script>
    <script src="{% static 'js/plugins/bootstrap-markdown/markdown.js' %}"></script>


 <script type="text/javascript">



    $(document).ready(function() {


        if(window.localStorage) {
        localStorageSupport = true
        }

         if (localStorageSupport){
                localStorage.removeItem("notifications_count", 0);
                $('#notification_count').hide()
        }

        var view_event = function(event_id,view_comment){
            $.ajax({
                 url: "{% url 'n:get_event_details' %}", // the endpoint
                 type: "POST", // http method
                 data: {
                     "event_id": event_id,
                     "comments_window": view_comment,
                 },
                 // handle a successful response
                 success: function(json) {
                     html = json
                     $('#event_modal').html(html)
                     $('#event_modal').modal('show')
                 },
                 // handle a non-successful response
                 error: function(xhr, errmsg, err) {
                     $('#results').html("<div class='alert-box alert radius' data-alert>Oops! We have encountered an error: " + errmsg +
                         " <a href='#' class='close'>&times;</a></div>"); // add the error to the dom
                     console.log(xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
                 }
             });
        }

        $('.view-event-details').click(function(){
              var event_id= $(this).attr( "event-id" );
              view_event(event_id,"false");
        })

        $('.view-event-comments').click(function(){
              var event_id= $(this).attr( "event-id" );
              view_event(event_id,"true");
        })



        $('.collapse-link').click(function (){
            style = $("#filter_properties").css("display");
            // none = Displayed
            // block = Hidden (yes it's flipped)
            if (style== "none")
                localStorage.setItem("ibox-collapsed",'on');
            else
                localStorage.setItem("ibox-collapsed",'off');
        })

        if (localStorageSupport){
            ibox_status = localStorage.getItem("ibox-collapsed")
            if (ibox_status=="off"){
                $("#filter_properties").css("display", "none");
                $("#ibox_filter").addClass('border-bottom')
            }
        }



    function getCookie(name) {
         var cookieValue = null;
         if (document.cookie && document.cookie != '') {
             var cookies = document.cookie.split(';');
             for (var i = 0; i < cookies.length; i++) {
                 var cookie = jQuery.trim(cookies[i]);
                 // Does this cookie string begin with the name we want?
                 if (cookie.substring(0, name.length + 1) == (name + '=')) {
                     cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                     break;
                 }
             }
         }
         return cookieValue;
     }

     var csrftoken = getCookie('csrftoken');

     function csrfSafeMethod(method) {
         // these HTTP methods do not require CSRF protection
         return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
     }

     $.ajaxSetup({
         beforeSend: function(xhr, settings) {
             if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                 xhr.setRequestHeader("X-CSRFToken", csrftoken);
             }
         }
     });



     function getParameterByName(name, url) {
    if (!url) url = window.location.href;
    name = name.replace(/[\[\]]/g, "\\$&");
    var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)", "i"),
        results = regex.exec(url);
    if (!results) return null;
    if (!results[2]) return '';
    return decodeURIComponent(results[2].replace(/\+/g, " "));
}

    var ibox_header = ""
    var event_type = getParameterByName('event_type'); // "lorem"
    var event_id = getParameterByName('event_id'); // "" (present with empty value)
    var event_state = getParameterByName('event_state'); // "" (present with no value)
    var event_message = getParameterByName('event_message'); // null (absent)
    var alarm_raised = getParameterByName('alarm_raised'); // null (absent)
    var is_ack = getParameterByName('is_ack'); // null (absent)
    var server = getParameterByName('server'); // null (absent)


    if(server){
        ibox_header += " | Server :  <b>"+ $('#id_server option:selected').html()+"</b>"
    }
    if(event_type){
        ibox_header += " | Event type :  <b>"+ $('#id_event_type option:selected').html()+"</b>"
    }
    if(event_id){
        ibox_header += " | Event ID :  <b>"+ $('#id_event_id option:selected').html()+"</b>"
    }
    if(event_state){
        ibox_header += " | Event State :  <b>"+ $('#id_event_state option:selected').html()+"</b>"
    }
    if(event_message){
        ibox_header += " | Event Message contains  <b>'"+ $('#id_event_message').val()+"'</b>"
    }
    if(alarm_raised){
        var val = $('#id_alarm_raised option:selected').html()
        if (val!="Unknown")
            ibox_header += " | Is Raised? : "+val
    }
    if(is_ack){
        var val = $('#id_is_ack option:selected').html()
        if (val!="Unknown")
            ibox_header += " | Is Acknowledged ? : <b>"+ $('#id_is_ack option:selected').html()+"</b>"
    }
    $('#filter-details').html(ibox_header)
});



        </script>
    {% endblock customjs %}
