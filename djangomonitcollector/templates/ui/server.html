{% extends "base.html" %}
{% load staticfiles %}
{% load extra_tags %}
{% block head %}
    <link href="{% static 'css/plugins/c3/c3.min.css' %}" rel="stylesheet">

{% endblock %}
{% block page_title %} Server : <small class="text-navy">{{ server.localhostname }}</small> <br/> IP : <small class="text-navy">{{ server.external_ip }}</small> {% endblock %}

{% block submenu %}
  <li class="nav-item">
    <a class="nav-link" href="{% url 'ui:server_alerts' server.id %}"><i class="fa fa-bell"></i>Active Alerts <span
    class="label label-{{ alerts_count|status_alert }} pull-right">{{ alerts_count }}</span></a>
  </li>
   <li class="nav-item">
    <a class="nav-link" href="{% url 'ui:server_kpis' server.id %}"><i class="fa fa-bar-chart"></i> Key Performance Indicators</a>
  </li>
  <li class="nav-item">
        <a class="nav-link scroll" href="#processes"><i class="fa fa-bullseye"></i> Processes</a>
    </li>
          <li class="nav-item">
        <a class="nav-link scroll" href="#programs"><i class="fa fa-bullseye"></i> Programs</a>
    </li>
      <li class="nav-item">
        <a class="nav-link scroll" href="#filesystems"><i class="fa fa-bullseye"></i> FileSystems</a>
    </li>
    <li class="nav-item">
        <a class="nav-link scroll" href="#directory"><i class="fa fa-bullseye"></i> Directories </a>
    </li>
    <li class="nav-item">
        <a class="nav-link scroll" href="#files" ><i class="fa fa-bullseye"></i> Files</a>
    </li>
    <li class="nav-item">
        <a class="nav-link scroll" href="#network"><i class="fa fa-bullseye"></i> Network</a>
    </li>
        <li class="nav-item">
        <a class="nav-link scroll" href="#host"><i class="fa fa-bullseye"></i> Host</a>
    </li>
  <li class="nav-item">
    <a class="nav-link" href="{% url 'ui:server_show' server.id %}"><i class="fa fa-wrench"></i> Server Settings</a>
  </li>
{% endblock %}
{% block content %}
  <div class="row clearfix">

    <div class="col-md-12 column2">
      <div class="col-lg-4 col-md-6 column">
        <div id="cpu-chart" class="graph" style="width:100%;"></div>
      </div>
      <div class="col-lg-4 col-md-6 column">
        <div id="memory-chart" class="graph" style="width:100%;"></div>
      </div>
      <div class="col-lg-4 col-md-6 column">
        <div id="disk-chart" class="graph" style="width:100%;"></div>
      </div>
    </div>
    <hr class="divider">
    <div class="col-md-12 column2">
      <div class="col-lg-4 col-md-6 column">
        <div id="graph_load" class="graph" style="width:100%;"></div>

      </div>

      <div class="col-lg-4 col-md-6 column">
        <div id="graph_cpu" class="graph" style="width:100%;"></div>
      </div>
      <div class="col-lg-4 col-md-6 column">
        <div id="graph_mem" class="graph" style="width:100%;"></div>
      </div>

    </div>

  </div>
  <div class="row clearfix marginTop">
    {% if processes %}
      <div id="processes" class="col-md-12 column">
        <div class="ibox">
            <div class="ibox-title">
                    <h5>Processes </h5>
                    <div class="ibox-tools">
                        <a class="collapse-link">
                            <i class="fa fa-chevron-up"></i>
                        </a>
                    </div>
                </div>
                <div class="ibox-content">
                <div class="row">
          {% include "ui/includes/server_table.html" %}
                </div>
                </div>
                </div>
      </div>
      {%  endif %}
      {% if programs %}
        <div id="programs" class="col-md-12 column">
         <div class="ibox">
            <div class="ibox-title">
                    <h5>Programs </h5>
                    <div class="ibox-tools">
                        <a class="collapse-link">
                            <i class="fa fa-chevron-up"></i>
                        </a>
                    </div>
                </div>
                <div class="ibox-content">
                <div class="row">
            {% include "ui/includes/program_table.html" %}
            </div>
            </div>
        </div>
      {% endif %}
      {% if filesystems %}
        <div id="filesystems" class="col-md-12 column">
         <div class="ibox">
            <div class="ibox-title">
                    <h5>Filesystems </h5>
                    <div class="ibox-tools">
                        <a class="collapse-link">
                            <i class="fa fa-chevron-up"></i>
                        </a>
                    </div>
                </div>
                <div class="ibox-content">
                <div class="row">
            {% include "ui/includes/filesystem_table.html" %}
          </div>
          </div>
          </div>
        </div>
      {% endif %}
      {% if directories %}
        <div  id="directory" class="col-md-12 column">
                <div class="ibox">
            <div class="ibox-title">
                    <h5>Directories </h5>
                    <div class="ibox-tools">
                        <a class="collapse-link">
                            <i class="fa fa-chevron-up"></i>
                        </a>
                    </div>
                </div>
                <div class="ibox-content">
                <div class="row">
            {% include "ui/includes/directory_table.html" %}
            </div>
            </div>
          </div>
        </div>
      {% endif %}
      {% if files %}
        <div id="files" class="col-md-12 column">
               <div class="ibox">
            <div class="ibox-title">
                    <h5>Files </h5>
                    <div class="ibox-tools">
                        <a class="collapse-link">
                            <i class="fa fa-chevron-up"></i>
                        </a>
                    </div>
                </div>
                <div class="ibox-content">
                <div class="row">
            {% include "ui/includes/file_table.html" %}
            </div>
            </div>
          </div>
        </div>
      {% endif %}
      {% if nets %}
        <div id="network" class="col-md-12 column">
         <div class="ibox">
            <div class="ibox-title">
                    <h5>Network </h5>
                    <div class="ibox-tools">
                        <a class="collapse-link">
                            <i class="fa fa-chevron-up"></i>
                        </a>
                    </div>
                </div>
                <div class="ibox-content">
                <div class="row">
            {% include "ui/includes/net_table.html" %}
            </div>
            </div>
          </div>
        </div>
      {% endif %}
      {% if hosts %}
        <div id="host" class="col-md-12 column">
            <div class="ibox">
            <div class="ibox-title">
                    <h5>Hosts </h5>
                    <div class="ibox-tools">
                        <a class="collapse-link">
                            <i class="fa fa-chevron-up"></i>
                        </a>
                    </div>
                </div>
                <div class="ibox-content">
                <div class="row">
            {% include "ui/includes/host_table.html" %}
            </div>
            </div>
          </div>
        </div>
      {% endif %}
    </div>
    {% csrf_token %}
  {% endblock %}
  {% block customjs %}
    <script src="{% static 'js/jquery-2.1.4.min.js' %}"></script>
    <script src="{% static 'js/dygraph-combined.js' %}"></script>
    <script src="{% static 'js/csrf.js' %}"></script>
    <script src="http://code.highcharts.com/highcharts.js"></script>
    <script src="{% static 'js/synchronizer.js' %}"></script>
    <script src="{% static 'js/graphite.js' %}"></script>
    <script>
$(function() {
    Highcharts.setOptions({
        colors: [
            '#1ab394',
            '#d1dade',
            '#f8ac59',
            '#1c84c6',
            '#a3e1d4',
            '#ed5565',
            '#1ab394',
            '#d1dade',
        ]
    });

      $("#graph_load").dygraphite({
        target: [
          ['{{server.localhostname|normalize}}.system.load.avg01', 'Load 1 min'],
          ['{{server.localhostname|normalize}}.system.load.avg05','Load 5 min'],
          ['{{server.localhostname|normalize}}.system.load.avg15','Load 15 min'],
        ],
        from:"-30mins"
      },{
        ylabel : "%"
      });

      $("#graph_cpu").dygraphite({
        target: [
          ['{{server.localhostname|normalize}}.system.cpu.user', 'User'],
          ['{{server.localhostname|normalize}}.system.cpu.system','System'],
          ['{{server.localhostname|normalize}}.system.cpu.wait','I/O Wait'],
        ],
        from:"-30mins"
      },{
        ylabel : "%"
      });

      $("#graph_mem").dygraphite({
        target: [
          ['{{server.localhostname|normalize}}.system.memory.percent', 'Memory'],
          ['{{server.localhostname|normalize}}.system.swap.percent','Swap'],
        ],
        from:"-30mins"
      },{
            ylabel : "%",
            valueRange: [0,100],
            labelsKMB : false,
      });

  /*

    var gs = []
        gs.push(graph_mem)
        gs.push(graph_cpu)
        gs.push(graph_load)

    var sync = Dygraph.synchronize(gs, {
          range: false,
          selection:true,
          zoom:true,
        });
*/


    chart_cpu = new Highcharts.Chart({
        chart: {
            renderTo: 'cpu-chart',
            plotBackgroundColor: null,
            plotBorderWidth: 0,
            plotShadow: false,
            backgroundColor:'rgba(255, 255, 255, 0.1)'
        },
         colors: [
            '#f8ac59',
            '#1ab394',
            '#d1dade',
            '#1c84c6',
            '#a3e1d4',
            '#ed5565',
            '#1ab394',
            '#d1dade',
        ],
        title: {
            text: 'CPU<br>Usage',
            align: 'center',
            verticalAlign: 'middle',
            y: 40
        },
        tooltip: {
            pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
        },
        plotOptions: {
            pie: {
                dataLabels: {
                    enabled: true,
                    distance: -50,
                    style: {
                        fontWeight: 'bold',
                        color: 'white',
                        textShadow: '0px 1px 2px black'
                    }},
                startAngle: -90,
                endAngle: 90,
                center: ['50%', '75%']
            }},
        series: [{
            type: 'pie',
            name: 'cpu',
            innerSize: '50%',
            data: [
                ['Wait', {{server.system.cpu_wait_last}}],
                ['User', {{server.system.cpu_user_last}}],
                ['Idle', 100 - {{server.system.cpu_wait_last}} - {{server.system.cpu_user_last}}]
            ]
        }]
    });
    chart_memory = new Highcharts.Chart({
        chart: {
            renderTo: 'memory-chart',
            plotBackgroundColor: null,
            plotBorderWidth: 0,
            plotShadow: false,
            backgroundColor:'rgba(255, 255, 255, 0.1)'
        },
        title: {
            text: 'Memory<br>Usage',
            align: 'center',
            verticalAlign: 'middle',
            y: 40
        },
        tooltip: {
            pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
        },
        plotOptions: {
            pie: {
                dataLabels: {
                    enabled: true,
                    distance: -50,
                    style: {
                        fontWeight: 'bold',
                        color: 'white',
                        textShadow: '0px 1px 2px black'
                    }},
                startAngle: -90,
                endAngle: 90,
                center: ['50%', '75%']
            }},
        series: [{
            type: 'pie',
            name: 'Memory',
            innerSize: '50%',
            data: [
                ['Used', {{server.system.memory_percent_last}}],
                ['Free', 100 - {{server.system.memory_percent_last}}],
            ]
        }]
    });
    chart_disk = new Highcharts.Chart({
        chart: {
            renderTo: 'disk-chart',
            plotBackgroundColor: null,
            plotBorderWidth: 0,
            plotShadow: false,
            backgroundColor:'rgba(255, 255, 255, 0.1)'
        },
        title: {
            text: 'Disk<br>Usage',
            align: 'center',
            verticalAlign: 'middle',
            y: 40
        },
        tooltip: {
            pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
        },
        plotOptions: {
            pie: {
                dataLabels: {
                    enabled: true,
                    distance: -50,
                    style: {
                        fontWeight: 'bold',
                        color: 'white',
                        textShadow: '0px 1px 2px black'
                    }},
                startAngle: -90,
                endAngle: 90,
                center: ['50%', '75%']
            }},
        series: [{
            type: 'pie',
            name: 'Disk',
            innerSize: '50%',
            data: [
                ['Used', {{disk_usage}}],
                ['Free', 100 - {{disk_usage}}],
            ]
        }]
    });
    var socket = io('/{{ server.id|clean }}');
    socket.on('dmc', function(msg) {
        var data = msg.data;
        // var cpu_system_last=['System', data.cpu_system_last];

        if (null != data.cpu_wait_last) {
            var cpu_wait_last = ['Wait', data.cpu_wait_last];
            var cpu_user_last = ['User', data.cpu_user_last];
            var cpu_idle_last = ['Idle', 100 - (data.cpu_user_last + data.cpu_wait_last)];
            var graph_data = [cpu_wait_last, cpu_user_last, cpu_idle_last];
            var memory_percent_last = ['Used', data.memory_percent_last];
            var free_memory_percent_last = ['Free', 100 - data.memory_percent_last];
            var memory_data = [memory_percent_last, free_memory_percent_last]
            chart_cpu.series[0].setData(graph_data, true);
            chart_memory.series[0].setData(memory_data, true);
            chart_cpu.redraw();
            chart_memory.redraw();
        }
        if (null != data.fs_blocks_percent_last) {
            var used_disk = ['Used' , data.fs_blocks_percent_last];
            var free_disk = ['Free', 100 - data.fs_blocks_percent_last];
            var graph_data = [used_disk, free_disk]
            chart_disk.series[0].setData(graph_data, true);
            chart_disk.redraw();
            }
        }
    );



});

  var hashTagActive = "";
    $(".scroll").click(function (event) {
        if(hashTagActive != this.hash) { //this will prevent if the user click several times the same link to freeze the scroll.
            event.preventDefault();
            //calculate destination place
            var dest = 0;
            if ($(this.hash).offset().top > $(document).height() - $(window).height()) {
                dest = $(document).height() - $(window).height();
            } else {
                dest = $(this.hash).offset().top - 65;
            }
            //go to destination
            $('html,body').animate({
                scrollTop: dest
            }, 200, 'swing');
            hashTagActive = this.hash;
        }
    });

    </script>
    <script src="{% static 'js/server.js' %}"></script>
  {% endblock customjs %}
