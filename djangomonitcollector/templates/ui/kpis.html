{% extends "base.html" %}
{% load staticfiles %}
{% load extra_tags %}
{% block head %}
    <link href="{% static 'css/plugins/c3/c3.min.css' %}" rel="stylesheet">

{% endblock %}
{% block page_title %} Key Performance Indicators  <br/> Server : <small class="text-navy">{{ server.localhostname }}</small> <br/> IP : <small class="text-navy">{{ server.external_ip }}</small> {% endblock %}

{% block submenu %}
  <li class="nav-item">
    <a class="nav-link" href="{% url 'ui:server_alerts' server.id %}"><i class="fa fa-bell"></i>Active Alerts <span
    class="label label-{{ alerts_count|status_alert }} pull-right">{{ alerts_count }}</span></a>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="{% url 'ui:server_show' server.id %}"><i class="fa fa-wrench"></i> Server Settings</a>
  </li>
{% endblock %}
{% block content %}
  <div class="row clearfix text-center">

<div id="kpis" class="btn-group" data-toggle="buttons">
  <label class="btn btn-primary btn-outline">
    <input type="checkbox" autocomplete="off" id="system"> System
  </label>
    <label class="btn btn-primary btn-outline">
    <input type="checkbox" autocomplete="off" id="network"> Network
  </label>
  <label class="btn btn-primary btn-outline">
    <input type="checkbox" autocomplete="off" id="filesystem"> FileSystems
  </label>
</div>


<div id="periods" class="btn-group" data-toggle="buttons">
  <label class="btn btn-primary btn-outline ">
    <input type="radio" id="1h" autocomplete="off"> 1h
  </label>
   <label class="btn btn-primary btn-outline ">
    <input type="radio" id="3h" autocomplete="off"> 3h
  </label>
  <label class="btn btn-primary btn-outline active">
    <input type="radio" id="1d" autocomplete="off"> 1d
  </label>
    <label class="btn btn-primary btn-outline">
    <input type="radio" id="1w" autocomplete="off"> 1w
  </label>
      <label class="btn btn-primary btn-outline">
    <input type="radio" id="1m" autocomplete="off"> 1m
  </label>
       <label class="btn btn-primary btn-outline">
    <input type="radio" id="1y" autocomplete="off"> 1y
  </label>

  <label class="btn btn-primary btn-outline">
    <input type="radio" id="max" autocomplete="off"> max
  </label>
</div>


</div>
  <div class="row clearfix top-buffer">

    <div class="ibox float-e-margins ui-draggable ui-droppable">
       <div class="ibox-title"> <h5>System Load</h5>
            <div class="ibox-tools">
                <a class="collapse-link">
                    <i class="fa fa-chevron-up"></i>
                </a>
            </div>
       </div>
       <div class="ibox-content">
            <div id="graph_load" class="graph" style="width:100%;">

            </div>
          </div>
    </div>

   <div class="ibox float-e-margins ui-draggable ui-droppable">
   <div class="ibox-title"> <h5>CPU Usage</h5>
        <div class="ibox-tools">
        <a class="collapse-link">
            <i class="fa fa-chevron-up"></i>
        </a>
    </div>
   </div>
   <div class="ibox-content">
        <div id="graph_cpu" class="graph" style="width:100%;"></div>
        </div>
      </div>
   <div class="ibox float-e-margins ui-draggable ui-droppable">
   <div class="ibox-title"> <h5>System Memory</h5>
        <div class="ibox-tools">
        <a class="collapse-link">
            <i class="fa fa-chevron-up"></i>
        </a>
    </div>
   </div>
   <div class="ibox-content">
        <div id="graph_mem" class="graph" style="width:100%;"></div>
        </div>
      </div>

    {% for nic in server.net_set.all %}
       <div class="ibox float-e-margins ui-draggable ui-droppable">

   <div class="ibox-title"> <h5> Network traffic: <b class="text-info">{{nic.name}}</b></h5>
        <div class="ibox-tools">
        <a class="collapse-link">
            <i class="fa fa-chevron-up"></i>
        </a>
    </div>
   </div>
   <div class="ibox-content">
        <div id="network_graph_packets_{{nic.name}}" class="graph" style="width:100%;">

        </div>
          <div id="network_graph_bytes_{{nic.name}}" class="graph" style="width:100%;">

          </div>
          <div id="network_graph_errors_{{nic.name}}" class="graph" style="width:100%;">

          </div>
        </div>
      </div>

      <script type="text/javascript">
        $(function(){

          $("#network_graph_packets_{{nic.name}}").dygraphite({
            target: [
              ['{{server.localhostname|normalize}}.net.{{nic.name}}.download.packet', 'Download'],
              ['{{server.localhostname|normalize}}.net.{{nic.name}}.upload.packet','Upload'],
            ]
          },{
            ylabel : "Packets"
          });

          $("#network_graph_bytes_{{nic.name}}").dygraphite({
            target: [
              ['{{server.localhostname|normalize}}.net.{{nic.name}}.download.bytes', 'Download'],
              ['{{server.localhostname|normalize}}.net.{{nic.name}}.upload.bytes','Upload'],
            ]
          },{
            ylabel : "Bytes"
          });


          $("#network_graph_errors_{{nic.name}}").dygraphite({
            target: [
              ['{{server.localhostname|normalize}}.net.{{nic.name}}.download.errors', 'Download'],
              ['{{server.localhostname|normalize}}.net.{{nic.name}}.upload.errors','Upload'],
            ]
          },{
            ylabel : "Packets"
          });


        })
      </script>
    {% endfor %}


    {% for fs in server.filesystem_set.all %}
       <div class="ibox float-e-margins ui-draggable ui-droppable">

   <div class="ibox-title"> <h5> Filesystem Usage: <b class="text-info">{{fs.display_name}}</b></h5>
        <div class="ibox-tools">
        <a class="collapse-link">
            <i class="fa fa-chevron-up"></i>
        </a>
    </div>
   </div>
   <div class="ibox-content">
        <div id="fs_graph_blocks_usage_{{fs.name}}" class="graph" style="width:100%;">

        </div>
        <div id="fs_graph_blocks_percent_{{fs.name}}" class="graph" style="width:100%;">

        </div>
        <div id="fs_graph_inode_usage_{{fs.name}}" class="graph" style="width:100%;">

        </div>
        <div id="fs_graph_inode_percent_{{fs.name}}" class="graph" style="width:100%;">

        </div>
        </div>
      </div>
   <script type="text/javascript">
        $(function(){
         $("#fs_graph_blocks_percent_{{fs.name}}").dygraphite({
            target: [
              ['{{server.localhostname|normalize}}.fs.{{fs.name}}.blocks_percent', 'Blocks %'],
            ]
          },{
            ylabel : "%",
            valueRange: [0,100],
            labelsKMB : false,
          });
       });
      </script>
    {% endfor %}

</div>


    {% csrf_token %}
  {% endblock %}
  {% block customjs %}
    <script src="{% static 'js/jquery-2.1.4.min.js' %}"></script>
    <script src="{% static 'js/dygraph-combined.js' %}"></script>
    <script src="{% static 'js/csrf.js' %}"></script>
    <script src="{% static 'js/synchronizer.js' %}"></script>
    <script src="{% static 'js/graphite.js' %}"></script>
    <script>
    $(function() {

    // server side code
    var update_period = 1000 * {{monit_update_period}};

    // client side code will be consolidated in one file
    var gs = []

    // init parameters
    var point_size = 1;
    var stroke_width = 0.5;
    var rollperiod = 0;
    var draw_point = false;
    var isStacked = false;
    var errorbars = false;
    var graph_colors = ["#1ab394", "#ed5565", "#f8ac59", "#1c84c6"];
    var update_period = 1000 * {{monit_update_period}};


    {% if request.session.is_dst %}
    var dst_delta =3600
          {% else %}
    var dst_delta= 0 // 1h
        {% endif %}
/*
    var sync = Dygraph.synchronize(gs, {
          range: false,
          selection:true,
        });
*/

    $("#periods :input").change(function() {
        active = $(this).parent().hasClass("active")
       $.ajax({
               url: "{% url 'ui:set_stats_period'%}", // the endpoint
               type: "POST", // http method
               data: {
                   "period": this.id
               },
               // handle a successful response
               success: function(result) {
                  console.log(result)
               },
               // handle a non-successful response
               error: function(xhr, errmsg, err) {

                  if ($('#results').length){
                       $('#results').html("<div class='alert-box alert radius' data-alert>Oops! We have encountered an error: " + errmsg +
                       " <a href='#' class='close'>&times;</a></div>"); // add the error to the dom
                  }

                   console.log(xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
               }
          });
    });

    $("#kpis :input").change(function() {
        active = $(this).parent().hasClass("active")

        if(this.id=="filesystem"){
            $.ajax({
                 url: "{% url 'ui:get_filesystem_usage' server.id %}", // the endpoint
                 type: "POST", // http method
                 data: {
                     "kpi": "filesystem"
                 },
                 // handle a successful response
                 success: function(result) {
                    jQuery.each(result.res, function(i, data) {
                        draw_filesystem_graphs_for_fs(i,data);
                    });
                 },
                 // handle a non-successful response
                 error: function(xhr, errmsg, err) {

                    if ($('#results').length){
                         $('#results').html("<div class='alert-box alert radius' data-alert>Oops! We have encountered an error: " + errmsg +
                         " <a href='#' class='close'>&times;</a></div>"); // add the error to the dom
                    }

                     console.log(xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
                 }
            });

        }

        if(this.id=="system"){
            $.ajax({
                 url: "{% url 'ui:get_system_usage' server.id %}", // the endpoint
                 type: "POST", // http method
                 data: {
                     "kpi": "system"
                 },

                 // handle a successful response
                 success: function(result) {
                    draw_system_graphs(result.res);
                 },

                 // handle a non-successful response
                 error: function(xhr, errmsg, err) {

                    if ($('#results').length){
                         $('#results').html("<div class='alert-box alert radius' data-alert>Oops! We have encountered an error: " + errmsg +
                         " <a href='#' class='close'>&times;</a></div>"); // add the error to the dom
                    }

                     console.log(xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
                 }
            });
        }

        if(this.id=="network"){

            $.ajax({
                 url: "{% url 'ui:get_network_usage' server.id %}", // the endpoint
                 type: "POST", // http method
                 data: {
                     "kpi": "network"
                 },
                 // handle a successful response
                 success: function(result) {
                    jQuery.each(result.res, function(i, data) {
                        draw_network_graphs_for_nic(i,data);
                    });
                 },
                 // handle a non-successful response
                 error: function(xhr, errmsg, err) {

                    if ($('#results').length){
                         $('#results').html("<div class='alert-box alert radius' data-alert>Oops! We have encountered an error: " + errmsg +
                         " <a href='#' class='close'>&times;</a></div>"); // add the error to the dom
                    }

                     console.log(xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
                 }
            });

        }
    });

    var hashTagActive = "";
    $(".scroll").click(function (event) {
        if(hashTagActive != this.hash) { //this will prevent if the user click several times the same link to freeze the scroll.
            event.preventDefault();
            //calculate destination place
            var dest = 0;
            if ($(this.hash).offset().top > $(document).height() - $(window).height()) {
                dest = $(document).height() - $(window).height();
            } else {
                dest = $(this.hash).offset().top - 65;
            }
            //go to destination
            $('html,body').animate({
                scrollTop: dest
            }, 200, 'swing');
            hashTagActive = this.hash;
        }
    });

});

    </script>
    <script src="{% static 'js/server.js' %}"></script>
  {% endblock customjs %}
